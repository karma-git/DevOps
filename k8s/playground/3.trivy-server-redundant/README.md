# Обзор
[trivy](https://aquasecurity.github.io/trivy/v0.17.0/) - сканнер уязвимостей для контейнеров.

[Репозиторий](https://github.com/aquasecurity/trivy).
# Motivation
В случае если вы используете trivy для сканирования своих образов в промышленных масштабах, всплывает тот факт что при сканировании вы отправляете запрос к некой базе уязвимостей и количество запросов ограничено.

Оказывается, что trivy можно запускать в режиме [клиент/сервера](https://aquasecurity.github.io/trivy/v0.17.0/modes/client-server/). Но возникает новая сложность:

Если вы хотите сделать надежную инфрастуктуру, то вам необходимо поднять несколько экземпляров trivy server, однако это не stateless приложение, на каждом бэкэнде обрабатывая запрос trivy рядом с собой создает кеш уже обработанных образов.

Ошибка возникает если приходит запрос на обработку образа, который уже закеширован, но не на тот бэкэнд.

# Решение

У trivy есть флаг который позволяет использовать удаленное хранилище. В нашем примере используется редис.

# Инструкция
Подразумевается что кластер k8s уже запущен.

Устанавливаем необходимые ресурсы.
```bash
kubectl create -f .
```
Делаем порт форвардинг к сервису trivy-server.
```bash
kubectl port-forward service/trivy 8080:80 -n trivy
```
В другом терминале сканируем через наши бэкэнды.
```bash
$ trivy -q client --remote http://localhost:8080 alpine:3.10

alpine:3.10 (alpine 3.10.9)
===========================
Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 0, CRITICAL: 1)

+-----------+------------------+----------+-------------------+---------------+---------------------------------------+
|  LIBRARY  | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |                 TITLE                 |
+-----------+------------------+----------+-------------------+---------------+---------------------------------------+
| apk-tools | CVE-2021-36159   | CRITICAL | 2.10.6-r0         | 2.10.7-r0     | libfetch before 2021-07-26, as        |
|           |                  |          |                   |               | used in apk-tools, xbps, and          |
|           |                  |          |                   |               | other products, mishandles...         |
|           |                  |          |                   |               | -->avd.aquasec.com/nvd/cve-2021-36159 |
+-----------+------------------+----------+-------------------+---------------+---------------------------------------+
```
